# min machine type to install tensorflow: n1-standard-1
# min machine type to run detect_objects.py: g1-small

# install logging agent
$ sudo apt-get update
$ curl -sSO https://dl.google.com/cloudagents/install-logging-agent.sh
$ sudo bash install-logging-agent.sh --structured

# configure timezone
$ sudo ln -sf /usr/share/zoneinfo/Asia/Singapore /etc/localtime

# https://cloud.google.com/python/setup
$ sudo apt update
$ sudo apt install python3
$ sudo apt install python3-pip

# set up repo
$ sudo mkdir /opt/repositories
$ cd /opt/repositories
$ sudo git clone https://github.com/aaronteoh/streetcred.git

# install dependanciwes
$ cd streetcred
$ sudo pip3 install -r requirements.txt

# create credentials
$ sudo mkdir credentials
$ cd credentials
$ echo '<API KEY>' | sudo tee LTA-API-KEY

# test script
$ cd /opt/repositories/streetcred
$ sudo python3 download_images.py

# download models
$ sudo git clone https://github.com/tensorflow/models.git
$ cd models/research
$ sudo apt  install protobuf-compiler
$ sudo protoc object_detection/protos/*.proto --python_out=.
$ cp object_detection/packages/tf2/setup.py .
$ sudo python3 -m pip install .
$ sudo python3 object_detection/builders/model_builder_tf2_test.py


# TODO: figure out what this is
# ERROR: After October 2020 you may experience errors when installing or updating packages. This is because pip will change the way that it resolves dependency conflicts.
#
# We recommend you use --use-feature=2020-resolver to test your packages with the new resolver before it becomes the default.
#
# tensorflow 2.3.0 requires numpy<1.19.0,>=1.16.0, but you'll have numpy 1.19.1 which is incompatible.
# apache-beam 2.23.0 requires avro-python3!=1.9.2,<1.10.0,>=1.8.1; python_version >= "3.0", but you'll have avro-python3 1.10.0 which is incompatible.
# tensorflow-metadata 0.23.0 requires absl-py<0.9,>=0.7, but you'll have absl-py 0.9.0 which is incompatible.

# set up GCP credentials
# outside ssh
$ gcloud compute scp <path to gcs credentials> tyeoh-streetcred-1:<file name>
# insihde ssh
$ cd /home/$USER
$ mv <file name> /opt/repositories/streetcred/credentials/<file name>
$ cd /opt/repositories/streetcred/models/research/object_detection/test_data
$ sudo curl -O http://download.tensorflow.org/models/object_detection/tf2/20200711/centernet_resnet101_v1_fpn_512x512_coco17_tpu-8.tar.gz
$ sudo tar -zxvf centernet_resnet101_v1_fpn_512x512_coco17_tpu-8.tar.gz

# test script
$ cd /opt/repositories/streetcred
$ sudo python3 detect_objects.py

# debug: tail -f /var/log/kern.log